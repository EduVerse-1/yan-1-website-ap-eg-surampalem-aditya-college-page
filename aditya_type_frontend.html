<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>College Archive</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<style>
  /* ---------- GLOBAL ---------- */
  body {
    margin:0;
    font-family:"Poppins",Arial,sans-serif;
    background:#0f172a;
    color:#fff;
  }

  /* ---------- TABS ---------- */
  .tabs{
    display:flex;
    justify-content:space-around;
    background:#334155;
    border-bottom:1px solid #475569;
    flex-wrap:wrap;
  }
  .tab-btn{
    flex:1;
    padding:14px 0;
    cursor:pointer;
    text-align:center;
    font-size:18px;
    font-weight:600;
    background:#334155;
    border:none;
    color:#cbd5e1;
    transition:all .25s ease;
  }
  .tab-btn.active{
    color:#fff;
    border-bottom:3px solid #38bdf8;
  }

  /* ---------- CONTENT ---------- */
  .content{
    display:none;
    padding:16px;
    min-height:100vh;
  }
  .content.active{display:block;}
  h3{
    font-size:20px;
    color:#93c5fd;
    margin-bottom:14px;
    text-align:center;
  }

  /* ---------- CARD GRID ---------- */
  .cards{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:15px;
  }
  .card{
    background:#1e293b;
    padding:14px;
    border-radius:12px;
    transition:.25s;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
    position:relative;               /* for the absolute share‚Äëicon */
  }
  .card:hover{
    background:#334155;
    transform:translateY(-4px);
  }
  .thumb{
    width:100%;
    height:160px;
    border-radius:10px;
    object-fit:cover;
    margin-bottom:10px;
    background:#111;
  }
  .title{
    font-size:16px;
    font-weight:700;
    margin-bottom:4px;
    line-height:1.4;
  }
  .info{
    font-size:13px;
    color:#94a3b8;
    margin-bottom:8px;
  }
  .link a{
    color:#60a5fa;
    text-decoration:underline;
    word-break:break-all;
  }
  .description{                      /* NEW: description styling */
    font-size:.85em;
    color:#94a3b8;
    margin-top:6px;
  }

  /* ---------- ACTIONS ---------- */
  .card-actions{
    display:flex;
    gap:8px;
    margin-top:8px;
  }
  .btn-open{
    flex:1;
    padding:10px;
    border:none;
    border-radius:8px;
    background:#3b82f6;
    color:#fff;
    font-size:15px;
    font-weight:600;
    cursor:pointer;
    transition:.25s;
  }
  .btn-open:hover{background:#2563eb;}

  /* tiny share‚Äëicon (instead of a big button) */
  .share-icon{
    position:absolute;
    top:8px; right:8px;
    font-size:1.2rem;               /* ‚Äúvery small‚Äù */
    color:#fff;
    opacity:.7;
    cursor:pointer;
    user-select:none;
    transition:opacity .2s;
  }
  .share-icon:hover{opacity:1;}

  /* ---------- VIEWER ---------- */
  .viewer{
    position:fixed;
    top:0; left:0;
    width:100%; height:100vh;
    background:rgba(0,0,0,.92);
    display:none;
    justify-content:center;
    align-items:center;
    flex-direction:column;
    padding:10px;
    z-index:1000;
  }
  .viewer iframe{
    width:95%; height:80vh;
    background:#000;
    border-radius:8px;
    border:none;
  }
  .close-btn{
    background:#ef4444;
    border:none;
    color:#fff;
    padding:10px 20px;
    margin-top:12px;
    font-size:16px;
    font-weight:600;
    border-radius:8px;
    cursor:pointer;
  }
  .close-btn:hover{background:#dc2626;}

  /* ---------- RESPONSIVE ---------- */
  @media(max-width:768px){
    .tab-btn{font-size:16px;padding:12px 0;}
    .title{font-size:15px;}
    .thumb{height:150px;}
  }
  @media(max-width:480px){
    .title{font-size:14px;}
    .btn-open{font-size:14px;padding:8px;}
    .thumb{height:140px;}
  }
</style>
</head>

<body>

<!-- TABS -->
<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('acet')">ACET</button>
  <button class="tab-btn" onclick="switchTab('aec')">AEC</button>
  <button class="tab-btn" onclick="switchTab('agbs')">AGBS</button>
</div>

<!-- CONTENT AREAS -->
<div id="acet" class="content active">
  <h3>ACET Archives</h3>
  <div class="cards"></div>
</div>

<div id="aec" class="content">
  <h3>AEC Archives</h3>
  <div class="cards"></div>
</div>

<div id="agbs" class="content">
  <h3>AGBS Archives</h3>
  <div class="cards"></div>
</div>

<!-- FULLSCREEN VIEWER -->
<div class="viewer" id="viewer">
  <iframe id="viewFrame"></iframe>
  <button class="close-btn" onclick="closeViewer()">Close</button>
</div>

<script>
/* ==================== CONFIG ==================== */
const backendURL   = "https://aditya_type_displaying_backend.csethre.workers.dev/get-data";
const shareBaseURL = "https://yan-1-related-1.github.io/yan-1-website-shared-links-redirecting/ap-eg-surampalem-aditya-college-page-shared-links-redirecting.html";

/* ==================== STATE ==================== */
let allItems = [];                         // entire dataset
let currentIndex = { acet:0, aec:0, agbs:0 };   // kept for lazy‚Äëscroll fallback

/* ==================== HELPERS ==================== */
function getArchiveThumbnail(url){
  if (!url || !url.includes("archive.org/details/"))
    return "https://icon-library.com/images/no-image-icon/no-image-icon-0.jpg";
  const id = url.split("/details/")[1].split(/[/?#]/)[0];
  return `https://archive.org/services/img/${id}`;
}

function getArchiveId(url){
  if (!url || !url.includes("archive.org/details/")) return null;
  const part = url.split("/details/")[1];
  return part.split(/[/?#]/)[0];
}

/* ------------------- FETCH DESCRIPTION ------------------- */
async function fetchDescription(item, el){
  const id = getArchiveId(item.archive_url);
  if (!id){ el.textContent = 'Description not available.'; return; }
  try{
    const resp = await fetch(`https://archive.org/metadata/${id}`);
    const data = await resp.json();
    const raw = data?.metadata?.description;
    let txt = '';
    if (raw){
      txt = Array.isArray(raw) ? raw.join(' ') : raw;
    }
    if (!txt){ el.textContent = 'Description not available.'; return; }
    // strip HTML tags, collapse whitespace
    txt = txt.replace(/<[^>]*>/g,' ').replace(/\s+/g,' ').trim();
    const maxLen = 300;
    if (txt.length > maxLen) txt = txt.slice(0,maxLen).trim() + '‚Ä¶';
    el.textContent = txt;
  }catch(e){
    console.warn('Failed to fetch description for', id, e);
    el.textContent = 'Description not available.';
  }
}

/* ------------------- CARD CREATION ------------------- */
function showCard(item){
  const container = document.querySelector(`#${item.type?.toLowerCase()} .cards`);
  if (!container) return;

  const thumb   = getArchiveThumbnail(item.archive_url);
  const card    = document.createElement("div");
  const cardId  = `grid_${item.id}`;

  card.className = "card";
  card.id        = cardId;

  card.innerHTML = `
    <img class="thumb" src="${thumb}" alt="Thumbnail" loading="lazy">
    <p class="title">${item.title || "Untitled"}</p>
    <p class="info">üìå ID: ${item.id ?? "N/A"}</p>
    ${item.link ? `<p class="link"><a href="${item.link}" target="_blank" rel="noopener">${item.link}</a></p>` : ""}
    <div class="card-actions">
      <button class="btn-open">Open</button>
    </div>
  `;

  /* tiny share‚Äëicon (top‚Äëright) */
  const shareIcon = document.createElement("span");
  shareIcon.className = "share-icon";
  shareIcon.title     = "Share";
  shareIcon.textContent = "üîó";
  shareIcon.onclick   = () => shareCard(cardId);
  card.appendChild(shareIcon);

  /* Insert description element before actions */
  const descEl = document.createElement('p');
  descEl.className = 'description';
  descEl.textContent = 'Loading description‚Ä¶';
  const actions = card.querySelector('.card-actions');
  actions.parentNode.insertBefore(descEl, actions);
  fetchDescription(item, descEl);

  /* OPEN button */
  card.querySelector(".btn-open").onclick = () => openViewer(item.archive_url);

  container.appendChild(card);
}

/* ------------------- LOAD ALL ITEMS PER TAB ------------------- */
function loadAllItems(tabId){
  const filtered = allItems.filter(i => i.type?.toLowerCase()===tabId);
  const container = document.querySelector(`#${tabId} .cards`);
  if (!container) return;
  container.innerHTML = "";
  filtered.forEach(showCard);
  currentIndex[tabId] = filtered.length;
}

/* ------------------- FETCH DATA ------------------- */
async function loadData(){
  try{
    const resp = await fetch(backendURL);
    allItems   = await resp.json();

    // render all tabs
    loadAllItems("acet");
    loadAllItems("aec");
    loadAllItems("agbs");

    // after cards are on the page, see if a shared link exists
    handleSharedLink();
  }catch(e){
    console.error(e);
    alert("Error fetching data from backend");
  }
}

/* ------------------- VIEWER (iframe) ------------------- */
function openViewer(url){
  if (!url) return;
  const viewer = document.getElementById("viewer");
  const frame  = document.getElementById("viewFrame");
  viewer.style.display = "flex";
  frame.src = url.includes("archive.org")
             ? url.replace("/details/","/embed/")
             : url;
}
function closeViewer(){
  const viewer = document.getElementById("viewer");
  const frame  = document.getElementById("viewFrame");
  viewer.style.display = "none";
  frame.src = "";
}

/* ------------------- TAB SWITCHING ------------------- */
function switchTab(id){
  document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
  document.querySelector(`button[onclick="switchTab('${id}')"]`).classList.add("active");
  document.querySelectorAll(".content").forEach(c=>c.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

/* ------------------- SHARE LOGIC ------------------- */
function shareCard(cardId){
  const url = `${shareBaseURL}?grid_id=${cardId}`;
  if (navigator.share){
    navigator.share({title:"Check this archive",url})
      .catch(err=>console.warn("Web Share failed:",err));
  }else{
    navigator.clipboard.writeText(url)
      .then(()=>alert("Share link copied to clipboard"))
      .catch(()=>alert("Unable to copy link"));
  }
}

/* ------------------- HANDLE EXTERNAL SHARED LINK ------------------- */
function handleSharedLink(){
  const params = new URLSearchParams(window.location.search);
  const gridId = params.get("grid_id");
  if (!gridId) return;

  const targetItem = allItems.find(i=>`grid_${i.id}`===gridId);
  if (!targetItem) return;

  const targetTab = targetItem.type?.toLowerCase();
  if (!targetTab) return;

  switchTab(targetTab);
  loadAllItems(targetTab);

  // after DOM paint, scroll to card and auto‚Äëopen it
  setTimeout(()=>{
    const card = document.getElementById(gridId);
    if (!card) return;
    card.scrollIntoView({behavior:"smooth",block:"center"});
    const openBtn = card.querySelector(".btn-open");
    if (openBtn) openBtn.click();
  },300);
}

/* ------------------- INFINITE SCROLL (kept for safety) ------------------- */
window.addEventListener("scroll",()=>{
  const active = document.querySelector(".content.active");
  if (!active) return;
  const tabId = active.id;
  const {scrollTop,scrollHeight,clientHeight}=document.documentElement;
  if (scrollTop+clientHeight >= scrollHeight-50){
    const filtered = allItems.filter(i=>i.type?.toLowerCase()===tabId);
    if (currentIndex[tabId] < filtered.length){
      const next = filtered.slice(currentIndex[tabId], currentIndex[tabId]+30);
      next.forEach(showCard);
      currentIndex[tabId] += next.length;
    }
  }
});

/* ==================== START ==================== */
loadData();
</script>

</body>
</html>
